import Day6.parse
import Day6.run1
import Day6.run2

object Day6 {
    fun parse(input: String): Grid<Char> = Grid.parseCharGrid(input)

    fun Coordinate<Int>.directionChar(): Char = when(this) {
        Coordinate.left -> '<'
        Coordinate.right -> '>'
        Coordinate.up -> '^'
        Coordinate.down -> 'v'
        else -> 'X'
    }
    const val free = '.'
    val visited = "X<>^v".toCharArray()
    const val obstacle = '#'

    data class Guard(val location: Coordinate<Int>, val direction: Coordinate<Int>) {
        fun turnRight(): Guard = Guard(location, direction.turnRight())
        fun locationAhead(): Coordinate<Int> = location + direction
        fun stepForward(): Guard = Guard(location + direction, direction)
    }

    data class State(val grid: Grid<Char>, val guard: Guard) {
        fun guardHasLeft() = !grid.isInside(guard.location)
        fun isLooping(): Boolean = grid.get(guard.location) == guard.direction.directionChar()
    }

    fun oneStep(s: State): State {
        val obstacleAhead = s.grid.getSafe(s.guard.locationAhead()) == obstacle
        return if (obstacleAhead)
            State(s.grid, s.guard.turnRight())
        else
            State(
                s.grid.set(s.guard.location, s.guard.direction.directionChar()),
                s.guard.stepForward()
            )
    }

    fun initialState(input: Grid<Char>): State {
        val (guardLoc) = input.findAll('^')
        return State(
            input.set(guardLoc, free),
            Guard(guardLoc, Coordinate.up)
        )
    }

    fun visitedLocations(g: Grid<Char>): Int =
        g.findAll(visited::contains).count()

    fun run1(input: Grid<Char>): Int {
        tailrec fun rec(s: State): Int =
            if (s.guardHasLeft() || s.isLooping()) {
                visitedLocations(s.grid)
            } else {
                rec(oneStep(s))
            }
        return rec(initialState(input))
    }

    fun willLoop(g: Grid<Char>): Boolean {
        tailrec fun rec(s: State, steps: Int = 0): Boolean =
            if (s.guardHasLeft()) {
                false
            } else if(s.isLooping()) {
                true
            } else if(steps > 64000) {
                true
            } else {
                rec(oneStep(s), steps + 1)
            }
        return rec(initialState(g))
    }

    fun run2(input: Grid<Char>): Int =
        input.findAll(free).count { newObstacle ->
            willLoop(input.set(newObstacle, obstacle))
        }

}

fun main() {
    val input = """
        ........#.............................................#.........#..............#.......#....................#....................#
        ......................#........#........................#.............##............................#.#.............#..........#..
        ....#..................................#..................#.........#....#..............#..#......................#........#...#..
        .....#...#...............#................#..........................#......#.....................#.......................#.......
        ......................................................##.#....#..................................................................#
        #....#....................#..................................#.....................................#......................#.......
        .......#...........................#.......................#......#...#.................................................#...#.....
        ....................##..........................#................#..........................#.#..................#....#.........#.
        #..................................#...............#...............#.........................#............##......................
        .............................#....................................#...............#.........#..........#.......................#..
        .................................#............###.......#............##......#...............................#...............#.#..
        .#..........................................#.......#.......................##..#........#........#...............#...............
        ......#...#............#.#..............#...................#..........................................................##.........
        #................##....................................................................#........#.................#...#...........
        ...#..........#..........................##......#....#..............................#......................................#.....
        ..............................##.#..........................................................#..............................#......
        ......#...........#....#..................#............#....................................................................#.....
        .....................#........................#.......................................................#...........................
        ...................#.#..........................................................................................#.#...............
        .........................................##.........................................................#.......#...###......#........
        ...............................................................##.......................#..........................#..............
        ...#...........#.................#..............#......#.....#..........................#....................#....#...............
        .................................#................#................#..............................................#.......##.....#
        ........#..........................#................#.......................#...................#.................................
        .............................#.............................#..........#.........................#........#........................
        ....#................#.#................#...........................................................#...#....#......#......#......
        ........#..............................#...............................#.................#........................................
        ...........................................#..#........#...#...........#..#.............#.........................................
        .#.................#.#................................#................#.#..................................#........#............
        .......#..........................................#.................................................................#.............
        ...................#....................................................#..#...............................................#......
        ...#.#........#...#.....#.....................................................................................................#...
        ......#.........................#......................#.............#.....................#......................................
        ..........................#............#.................................#..#..........#........#......................#..........
        ...#..#......#.......................#........................#...................................................................
        ............#...........#................#..............#.........................................................................
        .#........#....#.........................................#........................................#...............................
        ...#......................##.........#.......#.#...........#................................................#...#.................
        ...........#......#.........#....#.....#.......................................................#.............#....................
        .............#...#..............................................#.........#.....##....................#...#.........#.............
        ...............#................................#..........................................#.....#.#.........................#...#
        ................#.....#..#.............#..............#..............#.......#....................................................
        ......#.........................................................................................................#.........##......
        ..#...........................#.#...........................................#..#.....#............................................
        ...#...#..................#..................................#.........#...................#..................................#...
        ............#..#.....................#.........................................#.......#..................................#.......
        ...#.......................................................................#.............................#........................
        ......#..................#....................................#......##...........................................................
        .#...............#.....#..........................................................................................#...............
        ...#.............#.........................#.....................#...#..........#....#............................#...............
        ...#............................#.......#...........#.........#........#.....#...........#...................................#....
        .....................#...................#................................#...............................#......#.........#..##..
        .............#........................................................................................#........................##.
        .....#.......#.......#............................................................................................................
        ............................................#................................................................#..............#.....
        ....#..#......................................................#...................................................#...............
        .................................#...##..................#.................................................#....#.................
        ........#...................................#...#..........................................................#......................
        ........................#........##...........#.......#........#...................................#..............................
        ...........#...#...................................................#..............#......#...............#.#..................#...
        ........#.............................................#...........................................................................
        ........#................#......#..........#..#........#.#.......#...#........................#..#......................#.......#.
        .......#..........................................................................................................#.....#.....#...
        ......................##....................#.....#.................#...........#.......................#.##..........#......#....
        ....................................##....................................................................#.................#.....
        ..#.................................#.#...........#............................................#....#.............................
        #...................................#...........................................#............#.........#...............#..........
        .......................#.............................................................#..........#...#.............#.....#.........
        #..................#.#.............................................................................#.................#............
        .....................#......#.......#...........#..........................................^...............................#......
        ................................#......................#.#.....#..............#..................#....#.#......#....#.............
        ............................................................................#........#.....................................#......
        .............#......................................................#...................................#......##..#....#.........
        ...............#.................#...................#...............#............................................................
        ..............#...........#..#...........................................#...................................#..........#.........
        ..........#...........................#...................#..............#...#.......#..........#...................#.............
        .............#.#..................................#....#..#............#.....................#................#...#.....#.........
        ...................#..........................................................#............##.....................................
        ...........................................#............#........................................................................#
        ..#..............................#....#...........................................................................................
        ..#..#............#...........................#...#...........#............#.....#.................#..............................
        ....#...................#.........#...............................................................................................
        .......#..........................#....................................##........#.................##...#.#........#..#...........
        .#........................#....#.......#.....#...................#.............................................#..................
        ..#...............................................................#................................................#..............
        .....#........................................#...................................................................................
        ..........................................#..........................................................#............................
        ....................###.........................#............................#...#...........#............#.......................
        .....#.....#...............#........#.#....#...................#...........#........#...........#.................................
        ................................................................................................#...##............................
        ......................#............#.........................#.......................#.....#...........#...#.#....................
        ............................#....................#..................#..............#..................................#...........
        ...........................#...................................#..............................................................#...
        ..................#................#.....................#...................#........#..............#............................
        ............#.............#.....................#..................#.........#......................#............#............#...
        ....#..........................#...............................................................................................#..
        ................#.....................................#.............................#...........#........................#........
        #.##...........#.........................................#...............#..........................................#.#...........
        ........................................#..............#.....................#............#.....#.................................
        .......#....##..#..#.....#........................................................................................................
        ....##.............#..............................#...............................................................................
        .....#........................#.........#..#......#........#......................#.......#..............#..........#.......#.....
        ..#....#.........................#.#....................#..#.......#.............#..................#........#..................#.
        ..........##....#........................................................................#........................................
        ........#......#................................................................................................#................#
        .....#.......#...#.............#....................................#..#........................#...#..............#....#.........
        .............#...................................................##...#...........................................................
        ..............#.............................................#.............#................#.............#..............#.........
        ..#....#..........#.....#......#......................#................................#...............................#..........
        .................................................................................##......#...........................#.....#......
        ..#....#..........#.......#.........................................#...............#..#............................#........#....
        ...........#........#.#....................#........#.....................................#..................#....................
        .......#............#................#...........#.............#......#.........#...........................#.....................
        #.#....#.#...............#....#.....#.......................#...............................#...................##...#............
        .................##...#.................................................................#...........................#.............
        .....#........................................#.........#...................................................#.....................
        ....................#.....................#................................................#...##.....................#...........
        ...............#...............................................................#....#.............................................
        .................#................#...#.....................................#......#....................#...............#.#.......
        ...................#............................................#..#....#..#........#...............................#.........#...
        ..#........#...............#..................#.....#..................#.....................................#........##...#......
        .....#.....#....#.....#................#.#.....................##.............................................................#...
        ................#............#......#......#.......................................................#....................#........#
        ........#..............#..#......................................................................##.....##........................
        .........#.............................#.........#.......................................#..........................#.##..........
        .#...................#........................................................#....#......................................#.......
        ....#..........#.....#.........................................................................................#..................
        .......#.............................#............#.........................#....#....#........#......#.....#.......#.............
        ..#.......#........................#........................#.....................................................................
        ........................#...............................#.#.............#................................#..................#.....
    """.trimIndent()
    val parsed = parse(input)
    println(run1(parsed))
    println(run2(parsed))
}
